<div class="admin-layout">
  <app-admin-sidebar />

  <div class="main-content">
    <app-admin-header />

    <div class="content-area">

      <!-- Loading overlay during save -->
      @if (saving()) {
      <div class="saving-overlay">
        <div class="saving-dialog">
          <div class="spinner"></div>
          <p>{{ translations().productsManagement.savingProduct }}</p>
        </div>
      </div>
      }

      <div class="controls-card">
        <div class="controls-row">
          <div class="search-box">
            <span class="material-icons">search</span>
            <input type="text" placeholder="{{translations().productsManagement.searchPlaceholder}}"
              [ngModel]="searchTerm()" (ngModelChange)="searchTerm.set($event)" class="search-input" />
          </div>

          <div class="filter-controls">
            <app-custom-select [options]="categoryOptions()"
              [placeholder]="translations().productsManagement.categoriesSearchPlaceholder"
              [ngModel]="selectedCategory()" (ngModelChange)="onCategoryChange($event)">
            </app-custom-select>

            <app-custom-select [options]="statusOptions()"
              [placeholder]="translations().productsManagement.filterByStatus.pleaseholder" [ngModel]="selectedStatus()"
              (ngModelChange)="selectedStatus.set($event)">
            </app-custom-select>

            @if (searchTerm() || selectedCategory() || selectedStatus()) {
            <button class="btn btn-secondary" (click)="clearFilters()">
              <span class="material-icons">clear</span>
              {{translations().productsManagement.clearFilters}}
            </button>
            }
          </div>
        </div>

        <div class="results-info">
          <p>{{translations().productsManagement.showingResult}}
            <strong>{{ filteredProducts().length }}</strong>
            {{translations().productsManagement.showingResultOf}}
            <strong>{{ totalProducts() }}</strong>
            {{translations().productsManagement.products}}
          </p>

          <button class="btn btn-primary" (click)="openAddProduct()">
            <span class="material-icons">add</span>
            {{translations().productsManagement.addNewProduct}}
          </button>
        </div>
      </div>

      <div class="products-table-card">
        @if (filteredProducts().length > 0) {
        <div class="table-container">
          <table class="products-table">
            <thead>
              <tr>
                <th>{{translations().productsManagement.product}}</th>
                <th>{{translations().productsManagement.category}}</th>
                <th>{{translations().productsManagement.price}}</th>
                <th>{{translations().productsManagement.stock}}</th>
                <th>{{translations().productsManagement.status}}</th>
                <th>{{translations().productsManagement.flag}}</th>
                <th>{{translations().productsManagement.actions}}</th>
              </tr>
            </thead>
            <tbody>
              @for (product of filteredProducts(); track product.id) {
              <tr class="product-row" (click)="editProduct(product)"
                [class.active-row]="editingProduct()?.id === product.id">
                <td>
                  <div class="product-info-cell">
                    <img [src]="product.mainImage" [alt]="product.name" class="product-thumb" />
                    <div class="product-texts">
                      <p class="product-name">{{ product.name }}</p>
                      <p class="product-brand">{{ product.brand }}</p>
                    </div>
                  </div>
                </td>
                <td>
                  <span class="category-tag">{{ getCategoryName(product.categoryId) }}</span>
                </td>
                <td>
                  <span class="product-price">{{ formatPrice(product.price) }}</span>
                </td>
                <td>
                  <span class="stock-count" [ngClass]="{
                      'stock-low': product.stockQuantity < 10 && product.stockQuantity > 0,
                      'stock-out': product.stockQuantity === 0
                    }">
                    {{ product.stockQuantity }}
                  </span>
                </td>
                <td>
                  <span class="status-badge" [ngClass]="getStatusClass(getProductStatus(product))">
                    {{ getProductStatus(product) }}
                  </span>
                </td>
                <td>
                  <div class="flags-container">
                    @if(product.isNew && product.isFeatured) {
                    <span class="flag-pill featured">{{ translations().productsManagement.feature }}</span>
                    <span class="flag-pill new">{{ translations().productsManagement.new }}</span>
                    }
                    @if (product.isFeatured) {
                    <span class="flag-pill featured">{{ translations().productsManagement.feature }}</span>
                    }
                    @if (product.isNew) {
                    <span class="flag-pill new">{{ translations().productsManagement.new }}</span>
                    }
                  </div>
                </td>
                <td>
                  <div class="action-buttons">
                    <span class="material-icons edit"
                      (click)="editProduct(product); $event.stopPropagation()">edit</span>
                    <span class="material-icons delete"
                      (click)="deleteProduct(product); $event.stopPropagation()">delete</span>
                  </div>
                </td>
              </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="pagination-bar">
          <div class="pagination-info">
            {{translations().productsManagement.pagination.page}} <strong>{{ currentPage() }}</strong>
            {{translations().productsManagement.pagination.of}} <strong>{{ totalPages() }}</strong>
            &mdash; {{ totalProducts() }} {{translations().productsManagement.pagination.items}}
          </div>
          <div class="pagination-controls">
            <button class="btn btn-pagination" [disabled]="currentPage() <= 1" (click)="goToPage(currentPage() - 1)">
              <span class="material-icons">chevron_left</span>
              {{translations().productsManagement.pagination.previous}}
            </button>

            @for (page of getPageNumbers(); track page) {
            <button class="btn btn-page-number" [class.active]="page === currentPage()" (click)="goToPage(page)">
              {{ page }}
            </button>
            }

            <button class="btn btn-pagination" [disabled]="currentPage() >= totalPages()"
              (click)="goToPage(currentPage() + 1)">
              {{translations().productsManagement.pagination.next}}
              <span class="material-icons">chevron_right</span>
            </button>
          </div>
        </div>
        } @else {
        <div class="empty-state">
          <div class="empty-icon">
            <span class="material-icons">inventory_2</span>
          </div>

          @if (totalProducts() === 0) {
          <!-- CASE 1: No products in the database -->
          <h3>{{translations().productsManagement.emptyState.noProductsTitle}}</h3>
          <p>{{translations().productsManagement.emptyState.noProductsSubtitle}}</p>
          <button class="btn btn-primary" (click)="openAddProduct()">
            <span class="material-icons">add</span>
            {{translations().productsManagement.addNewProduct}}
          </button>
          } @else {
          <!-- CASE 2: No results found for current filter -->
          <h3>{{translations().productsManagement.emptyState.noResultsTitle}}</h3>
          <p>{{translations().productsManagement.emptyState.noResultsSubtitle}}</p>
          <button class="btn btn-secondary" (click)="clearFilters()">
            <span class="material-icons">filter_alt_off</span>
            {{translations().productsManagement.clearFilters}}
          </button>
          }
        </div>
        }
      </div>

      <div id="product-form-section">
        @if (isFormOpen()) {
        <app-product-form [productData]="editingProduct()" [categories]="categories()" (save)="saveProduct($event)"
          (cancel)="closeForm()">
        </app-product-form>
        }
      </div>
    </div>
  </div>
</div>