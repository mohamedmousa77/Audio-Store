<div class="admin-layout">
  <app-admin-sidebar />

  <div class="main-content">
    <app-admin-header />

    <div class="content-area">

      <!-- Loading overlay during save -->
      @if (saving()) {
      <div class="saving-overlay">
        <div class="saving-dialog">
          <div class="spinner"></div>
          <p>Saving product...</p>
        </div>
      </div>
      }

      <div class="controls-card">
        <div class="controls-row">
          <div class="search-box">
            <span class="material-icons">search</span>
            <input type="text" placeholder="Search by name or brand..." [ngModel]="searchTerm()"
              (ngModelChange)="searchTerm.set($event)" class="search-input" />
          </div>

          <div class="filter-controls">
            <select [ngModel]="selectedCategory()" (ngModelChange)="onCategoryChange($event)" class="filter-select">
              <option [ngValue]="null">All Categories</option>
              @for (cat of categories(); track cat.id) {
              <option [ngValue]="cat.id">{{ cat.name }}</option>
              }
            </select>

            <select [ngModel]="selectedStatus()" (ngModelChange)="selectedStatus.set($event)" class="filter-select">
              <option value="">All Status</option>
              <option value="Available">Available</option>
              <option value="Low Stock">Low Stock</option>
              <option value="Unavailable">Unavailable</option>
            </select>

            @if (searchTerm() || selectedCategory() || selectedStatus()) {
            <button class="btn btn-secondary" (click)="clearFilters()">
              <span class="material-icons">clear</span>
              Clear
            </button>
            }
          </div>
        </div>

        <div class="results-info">
          <p>Showing <strong>{{ filteredProducts().length }}</strong> of <strong>{{ totalProducts() }}</strong>
            products</p>
          <button class="btn btn-primary" (click)="openAddProduct()">
            <span class="material-icons">add</span>
            Add New Product
          </button>
        </div>
      </div>

      <div class="products-table-card">
        <div class="table-container">
          <table class="products-table">
            <thead>
              <tr>
                <th>PRODUCT</th>
                <th>CATEGORY</th>
                <th>PRICE</th>
                <th>STOCK</th>
                <th>STATUS</th>
                <th>FLAGS</th>
                <th>ACTIONS</th>
              </tr>
            </thead>
            <tbody>
              @for (product of filteredProducts(); track product.id) {
              <tr class="product-row" (click)="editProduct(product)"
                [class.active-row]="editingProduct()?.id === product.id">
                <td>
                  <div class="product-info-cell">
                    <img [src]="product.mainImage" [alt]="product.name" class="product-thumb" />
                    <div class="product-texts">
                      <p class="product-name">{{ product.name }}</p>
                      <p class="product-brand">{{ product.brand }}</p>
                    </div>
                  </div>
                </td>
                <td>
                  <span class="category-tag">{{ getCategoryName(product.categoryId) }}</span>
                </td>
                <td>
                  <span class="product-price">{{ formatPrice(product.price) }}</span>
                </td>
                <td>
                  <span class="stock-count" [ngClass]="{
                      'stock-low': product.stockQuantity < 10 && product.stockQuantity > 0,
                      'stock-out': product.stockQuantity === 0
                    }">
                    {{ product.stockQuantity }}
                  </span>
                </td>
                <td>
                  <span class="status-badge" [ngClass]="getStatusClass(getProductStatus(product))">
                    {{ getProductStatus(product) }}
                  </span>
                </td>
                <td>
                  <div class="flags-container">
                    @if (product.isFeatured) {
                    <span class="flag-pill featured">FEATURE</span>
                    }
                    @if (product.isNew) {
                    <span class="flag-pill new">NEW</span>
                    }
                  </div>
                </td>
                <td>
                  <div class="action-buttons">
                    <span class="material-icons edit"
                      (click)="editProduct(product); $event.stopPropagation()">edit</span>
                    <span class="material-icons delete"
                      (click)="deleteProduct(product); $event.stopPropagation()">delete</span>
                  </div>
                </td>
              </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="pagination-bar">
          <div class="pagination-info">
            Page <strong>{{ currentPage() }}</strong> of <strong>{{ totalPages() }}</strong>
            &mdash; {{ totalProducts() }} total products
          </div>
          <div class="pagination-controls">
            <button class="btn btn-pagination" [disabled]="currentPage() <= 1" (click)="goToPage(currentPage() - 1)">
              <span class="material-icons">chevron_left</span>
              Previous
            </button>

            @for (page of getPageNumbers(); track page) {
            <button class="btn btn-page-number" [class.active]="page === currentPage()" (click)="goToPage(page)">
              {{ page }}
            </button>
            }

            <button class="btn btn-pagination" [disabled]="currentPage() >= totalPages()"
              (click)="goToPage(currentPage() + 1)">
              Next
              <span class="material-icons">chevron_right</span>
            </button>
          </div>
        </div>
      </div>

      <div id="product-form-section">
        @if (isFormOpen()) {
        <app-product-form [productData]="editingProduct()" [categories]="categories()" (save)="saveProduct($event)"
          (cancel)="closeForm()">
        </app-product-form>
        }
      </div>
    </div>
  </div>
</div>