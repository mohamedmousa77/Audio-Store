<div class="admin-layout">
  <app-admin-sidebar />

  <div class="main-content">
    <app-admin-header />

    <div class="content-area">

      <!-- Loading overlay during save -->
      @if (saving()) {
      <div class="saving-overlay">
        <div class="saving-dialog">
          <div class="spinner"></div>
          <p>{{ translations().categoriesManagement.form.saving }}</p>
        </div>
      </div>
      }

      <div class="stats-row">
        <div class="stat-box">
          <div class="stat-icon-square">
            <span class="material-icons">category</span>
          </div>
          <div class="stat-info">
            <p class="stat-label">{{ translations().categoriesManagement.stats.categories }}</p>
            <h3 class="stat-value">{{ categories().length }}</h3>
          </div>
        </div>

        <div class="stat-box">
          <div class="stat-icon-square">
            <span class="material-icons">inventory_2</span>
          </div>
          <div class="stat-info">
            <p class="stat-label">{{ translations().categoriesManagement.stats.products }}</p>
            <h3 class="stat-value">{{ getTotalProducts() }}</h3>
          </div>
        </div>

        @if (getTopCategory()) {
        <div class="stat-box">
          <div class="stat-icon-square">
            <span class="material-icons">star</span>
          </div>
          <div class="stat-info">
            <p class="stat-label">{{ translations().categoriesManagement.stats.topCategory }}</p>
            <h3 class="stat-value top-cat-name">{{ getTopCategory()?.name }}</h3>
          </div>
        </div>
        }
      </div>

      <!-- Controls Section -->
      <div class="controls-card">
        <div class="controls-row">
          <div class="search-box">
            <span class="material-icons">search</span>
            <input type="text" [placeholder]="translations().categoriesManagement.controls.searchPlaceholder"
              [ngModel]="searchTerm()" (ngModelChange)="searchTerm.set($event)" class="search-input" />
          </div>

          <div class="sort-controls">
            <app-custom-select [options]="sortOptions()"
              [placeholder]="translations().categoriesManagement.controls.sort.name" [ngModel]="sortBy()"
              (ngModelChange)="sortBy.set($event)">
            </app-custom-select>

            <button class="sort-toggle-btn" (click)="toggleSortOrder()"
              [title]="'Sort ' + (sortOrder() === 'asc' ? translations().categoriesManagement.controls.sort.asc : translations().categoriesManagement.controls.sort.desc)">
              <span class="material-icons">
                {{ sortOrder() === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
              </span>
            </button>

            <button class="view-toggle-btn" (click)="toggleViewMode()">
              <span class="material-icons">
                {{ viewMode() === 'grid' ? 'view_agenda' : 'apps' }}
              </span>
            </button>

            @if (searchTerm()) {
            <button class="btn btn-secondary" (click)="clearSearch()">
              <span class="material-icons">clear</span>
              {{ translations().categoriesManagement.controls.clearSearch }}
            </button>
            }
          </div>
        </div>

        <div class="results-info">
          <p>{{ translations().categoriesManagement.controls.resultsInfo.showing }} <strong>{{
              filteredCategories().length }}</strong> {{ translations().categoriesManagement.controls.resultsInfo.of }}
            <strong>{{ categories().length }}</strong>
            {{ translations().categoriesManagement.controls.resultsInfo.categories }}
          </p>
          <button class="btn btn-primary" (click)="openAddCategory()">
            <span class="material-icons">add</span>
            {{ translations().categoriesManagement.controls.addNew }}
          </button>
        </div>
      </div>

      <!-- TABLE VIEW -->
      @if (viewMode() === 'table') {
      <div class="categories-list-container">
        <table class="model-table">
          <thead>
            <tr>
              <th>{{ translations().categoriesManagement.table.image }}</th>
              <th>{{ translations().categoriesManagement.table.nameDesc }}</th>
              <th>{{ translations().categoriesManagement.table.products }}</th>
              <th>{{ translations().categoriesManagement.table.actions }}</th>
            </tr>
          </thead>
          <tbody>
            @for (category of filteredCategories(); track category.id) {
            <tr (click)="editCategory(category)" class="clickable-row">
              <td>
                <div class="table-image-box">
                  @if (category.imageUrl) {
                  <img [src]="category.imageUrl" [alt]="category.name" />
                  } @else {
                  <span class="material-icons">category</span>
                  }
                </div>
              </td>
              <td>
                <div class="name-desc-cell">
                  <strong>{{category.name}}</strong>
                  <p>{{category.description}}</p>
                </div>
              </td>
              <td>
                <span class="prod-count-badge clickable" [class.flash-red]="flashCategoryId() === category.id"
                  (click)="$event.stopPropagation(); getProductCount(category.id) > 0 ? navigateToProducts(category.id, category.name) : null">
                  {{getProductCount(category.id)}}
                  @if(getProductCount(category.id) > 0){
                  <span class="material-icons badge-arrow">arrow_forward</span>
                  }

                </span>
              </td>
              <td>
                <div class="actions">
                  <button class="action-btn edit-btn" (click)="$event.stopPropagation(); editCategory(category)"
                    [title]="translations().admin.edit">
                    <span class="material-icons">edit</span>
                  </button>
                  <button class="action-btn delete-btn" (click)="$event.stopPropagation();deleteCategory(category)"
                    [title]="translations().admin.delete">
                    <span class="material-icons">delete</span>
                  </button>
                </div>
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>
      }

      <!-- GRID VIEW -->
      @if (viewMode() === 'grid') {
      <div class="categories-grid">
        @for (category of filteredCategories(); track category.id) {
        <div class="category-card" (click)="editCategory(category)">
          <div class="card-image">
            @if (category.imageUrl) {
            <img [src]="category.imageUrl" [alt]="category.name" />
            } @else {
            <span class="material-icons">category</span>
            }
          </div>

          <div class="card-content">
            <h3 class="category-name">{{ category.name }}</h3>
            <p class="category-description">{{ category.description }}</p>

            <div class="category-meta">
              <div class="meta-item clickable" [class.flash-red]="flashCategoryId() === category.id"
                (click)="navigateToProducts(category.id, category.name)">
                <span class="material-icons">inventory_2</span>
                <span class="meta-value">{{ getProductCount(category.id) }} {{
                  translations().categoriesManagement.grid.products }}</span>
                <span class="material-icons meta-arrow">arrow_forward</span>
              </div>
            </div>
          </div>

          <div class="card-actions">
            <button class="action-btn edit-btn" (click)="$event.stopPropagation(); editCategory(category)"
              [title]="translations().admin.edit">
              <span class="material-icons">edit</span>
            </button>
            <button class="action-btn delete-btn" (click)="$event.stopPropagation(); deleteCategory(category)"
              [title]="translations().admin.delete">
              <span class="material-icons">delete</span>
            </button>
          </div>
        </div>
        }

        <!-- Empty State -->
        @if (filteredCategories().length === 0) {
        <div class="empty-state">
          <span class="empty-icon material-icons">category</span>
          <h3>{{ translations().categoriesManagement.grid.empty.title }}</h3>
          <p>{{ translations().categoriesManagement.grid.empty.subtitle }}</p>
        </div>
        }
      </div>
      }

      <!-- CATEGORY FORM -->
      @if (isFormOpen()) {
      <div id="category-form-section" class="form-section-card">
        <div class="form-header">
          <div class="header-info">
            <h2 class="detail-title">{{ editingCategory()?.id ? translations().categoriesManagement.form.editTitle :
              translations().categoriesManagement.form.addTitle }}
              <span>{{ editingCategory()?.id ? editingCategory()?.name : '' }}</span>
            </h2>
          </div>
          <div class="header-actions">
            <button class="btn btn-secondary" (click)="closeForm()">
              <span class="material-icons">close</span>{{ translations().categoriesManagement.form.cancel }}</button>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-inputs">
            <div class="form-group">
              <label>{{ translations().categoriesManagement.form.name }}</label>
              <input type="text" [ngModel]="formCategory().name" (ngModelChange)="updateFormName($event)"
                [placeholder]="translations().categoriesManagement.form.namePlaceholder" />
            </div>
            <div class="form-group">
              <label>{{ translations().categoriesManagement.form.description }}</label>
              <textarea [ngModel]="formCategory().description" (ngModelChange)="updateFormDescription($event)" rows="3"
                [placeholder]="translations().categoriesManagement.form.descriptionPlaceholder"></textarea>
            </div>
          </div>

          <div class="form-preview">
            <p class="preview-label">{{ translations().categoriesManagement.form.image.label }}</p>

            @if (formCategory().imageUrl) {
            <!-- Image preview with click to change -->
            <div class="image-preview-box" (click)="imageInput.click()">
              <img [src]="formCategory().imageUrl" alt="Category image" />
              <div class="image-overlay">
                <span class="material-icons">edit</span>
                <span>{{ translations().categoriesManagement.form.image.change }}</span>
              </div>
            </div>
            <button class="btn-remove-image" (click)="removeImage()">
              <span class="material-icons">delete</span> {{ translations().categoriesManagement.form.image.remove }}
            </button>
            } @else {
            <!-- Upload area -->
            <div class="upload-area" (click)="imageInput.click()">
              <span class="material-icons upload-icon">add_photo_alternate</span>
              <p class="upload-text">{{ translations().categoriesManagement.form.image.uploadTitle }}</p>
              <p class="upload-hint">{{ translations().categoriesManagement.form.image.uploadHint }}</p>
            </div>
            }

            <input type="file" #imageInput accept="image/*" (change)="onImageSelected($event)" style="display:none" />

            <div class="form-actions">
              <button class="btn btn-secondary" (click)="closeForm()">{{ translations().categoriesManagement.form.clear
                }}</button>
              <button class="btn btn-primary" (click)="saveCategory()" [disabled]="saving()">
                <span class="material-icons">save</span> {{ translations().categoriesManagement.form.save }}
              </button>
            </div>
          </div>
        </div>
      </div>
      }

    </div>
  </div>
</div>