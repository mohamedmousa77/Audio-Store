<div class="admin-layout">
  <app-admin-sidebar />

  <div class="main-content">
    <app-admin-header />

    <div class="content-area">

      <!-- Loading overlay during save -->
      @if (saving()) {
      <div class="saving-overlay">
        <div class="saving-dialog">
          <div class="spinner"></div>
          <p>Salvataggio in corso...</p>
        </div>
      </div>
      }

      <div class="stats-row">
        <div class="stat-box">
          <div class="stat-icon-square">
            <span class="material-icons">category</span>
          </div>
          <div class="stat-info">
            <p class="stat-label">Categories</p>
            <h3 class="stat-value">{{ categories().length }}</h3>
          </div>
        </div>

        <div class="stat-box">
          <div class="stat-icon-square">
            <span class="material-icons">inventory_2</span>
          </div>
          <div class="stat-info">
            <p class="stat-label">Products</p>
            <h3 class="stat-value">{{ getTotalProducts() }}</h3>
          </div>
        </div>

        @if (getTopCategory()) {
        <div class="stat-box">
          <div class="stat-icon-square">
            <span class="material-icons">star</span>
          </div>
          <div class="stat-info">
            <p class="stat-label">Top Category</p>
            <h3 class="stat-value top-cat-name">{{ getTopCategory()?.name }}</h3>
          </div>
        </div>
        }
      </div>

      <!-- Controls Section -->
      <div class="controls-card">
        <div class="controls-row">
          <div class="search-box">
            <span class="material-icons">search</span>
            <input type="text" placeholder="Search categories by name or description..." [ngModel]="searchTerm()"
              (ngModelChange)="searchTerm.set($event)" class="search-input" />
          </div>

          <div class="sort-controls">
            <select [ngModel]="sortBy()" (ngModelChange)="sortBy.set($event)" class="sort-select">
              <option value="name">Sort by Name</option>
              <option value="products">Sort by Products</option>
            </select>

            <button class="sort-toggle-btn" (click)="toggleSortOrder()"
              [title]="'Sort ' + (sortOrder() === 'asc' ? 'Descending' : 'Ascending')">
              <span class="material-icons">
                {{ sortOrder() === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
              </span>
            </button>

            <button class="view-toggle-btn" (click)="toggleViewMode()">
              <span class="material-icons">
                {{ viewMode() === 'grid' ? 'view_agenda' : 'apps' }}
              </span>
            </button>

            @if (searchTerm()) {
            <button class="btn btn-secondary" (click)="clearSearch()">
              <span class="material-icons">clear</span>
              Clear
            </button>
            }
          </div>
        </div>

        <div class="results-info">
          <p>Showing <strong>{{ filteredCategories().length }}</strong> of <strong>{{ categories().length }}</strong>
            categories</p>
          <button class="btn btn-primary" (click)="openAddCategory()">
            <span class="material-icons">add</span>
            Add New Category
          </button>
        </div>
      </div>

      <!-- TABLE VIEW -->
      @if (viewMode() === 'table') {
      <div class="categories-list-container">
        <table class="model-table">
          <thead>
            <tr>
              <th>IMAGE</th>
              <th>NAME & DESCRIPTION</th>
              <th>PRODUCTS</th>
              <th>ACTIONS</th>
            </tr>
          </thead>
          <tbody>
            @for (category of filteredCategories(); track category.id) {
            <tr>
              <td>
                <div class="table-image-box">
                  @if (category.imageUrl) {
                  <img [src]="category.imageUrl" [alt]="category.name" />
                  } @else {
                  <span class="material-icons">category</span>
                  }
                </div>
              </td>
              <td>
                <div class="name-desc-cell">
                  <strong>{{category.name}}</strong>
                  <p>{{category.description}}</p>
                </div>
              </td>
              <td>
                <span class="prod-count-badge clickable" [class.flash-red]="flashCategoryId() === category.id"
                  (click)="navigateToProducts(category.id, category.name)">
                  {{getProductCount(category.id)}}
                  <span class="material-icons badge-arrow">arrow_forward</span>
                </span>
              </td>
              <td>
                <div class="actions">
                  <button class="action-btn edit-btn" (click)="editCategory(category)" title="Modifica">
                    <span class="material-icons">edit</span>
                  </button>
                  <button class="action-btn delete-btn" (click)="deleteCategory(category)" title="Elimina">
                    <span class="material-icons">delete</span>
                  </button>
                </div>
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>
      }

      <!-- GRID VIEW -->
      @if (viewMode() === 'grid') {
      <div class="categories-grid">
        @for (category of filteredCategories(); track category.id) {
        <div class="category-card">
          <div class="card-image">
            @if (category.imageUrl) {
            <img [src]="category.imageUrl" [alt]="category.name" />
            } @else {
            <span class="material-icons">category</span>
            }
          </div>

          <div class="card-content">
            <h3 class="category-name">{{ category.name }}</h3>
            <p class="category-description">{{ category.description }}</p>

            <div class="category-meta">
              <div class="meta-item clickable" [class.flash-red]="flashCategoryId() === category.id"
                (click)="navigateToProducts(category.id, category.name)">
                <span class="material-icons">inventory_2</span>
                <span class="meta-value">{{ getProductCount(category.id) }} products</span>
                <span class="material-icons meta-arrow">arrow_forward</span>
              </div>
            </div>
          </div>

          <div class="card-actions">
            <button class="action-btn edit-btn" (click)="editCategory(category)" title="Modifica">
              <span class="material-icons">edit</span>
            </button>
            <button class="action-btn delete-btn" (click)="deleteCategory(category)" title="Elimina">
              <span class="material-icons">delete</span>
            </button>
          </div>
        </div>
        }

        <!-- Empty State -->
        @if (filteredCategories().length === 0) {
        <div class="empty-state">
          <span class="empty-icon material-icons">category</span>
          <h3>No Categories Found</h3>
          <p>Try adjusting your search or filters</p>
        </div>
        }
      </div>
      }

      <!-- CATEGORY FORM -->
      @if (isFormOpen()) {
      <div id="category-form-section" class="form-section-card">
        <div class="form-header">
          <div class="header-info">
            <h2 class="detail-title">{{ editingCategory()?.id ? 'Edit Category: ' : 'Add New Category' }}
              <span>{{ editingCategory()?.id ? editingCategory()?.name : '' }}</span>
            </h2>
          </div>
          <div class="header-actions">
            <button class="btn btn-secondary" (click)="closeForm()">
              <span class="material-icons">close</span>Cancel</button>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-inputs">
            <div class="form-group">
              <label>Category Name</label>
              <input type="text" [ngModel]="formCategory().name" (ngModelChange)="updateFormName($event)"
                placeholder="e.g. Headphones" />
            </div>
            <div class="form-group">
              <label>Description</label>
              <textarea [ngModel]="formCategory().description" (ngModelChange)="updateFormDescription($event)" rows="3"
                placeholder="Describe this category..."></textarea>
            </div>
          </div>

          <div class="form-preview">
            <p class="preview-label">Category Image</p>

            @if (formCategory().imageUrl) {
            <!-- Image preview with click to change -->
            <div class="image-preview-box" (click)="imageInput.click()">
              <img [src]="formCategory().imageUrl" alt="Category image" />
              <div class="image-overlay">
                <span class="material-icons">edit</span>
                <span>Change Image</span>
              </div>
            </div>
            <button class="btn-remove-image" (click)="removeImage()">
              <span class="material-icons">delete</span> Remove Image
            </button>
            } @else {
            <!-- Upload area -->
            <div class="upload-area" (click)="imageInput.click()">
              <span class="material-icons upload-icon">add_photo_alternate</span>
              <p class="upload-text">Click to upload image</p>
              <p class="upload-hint">JPG, PNG (max 5MB)</p>
            </div>
            }

            <input type="file" #imageInput accept="image/*" (change)="onImageSelected($event)" style="display:none" />

            <div class="form-actions">
              <button class="btn btn-secondary" (click)="closeForm()">Clear</button>
              <button class="btn btn-primary" (click)="saveCategory()" [disabled]="saving()">
                <span class="material-icons">save</span> Save Category
              </button>
            </div>
          </div>
        </div>
      </div>
      }

    </div>
  </div>
</div>